<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test de Orientaci√≥n TP ‚Äî Liceo Bicentenario Industrial Ricardo Fenner Ruedi</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#f59e0b;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --link:#60a5fa; --chip:#1f2937;
      --border: rgba(255,255,255,.08);
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --brand:#b45309;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626; --link:#2563eb; --chip:#f3f4f6;
      --border: rgba(0,0,0,.08);
    }

    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(180deg,#0b1024,var(--bg)); color:var(--ink);
      transition: background .3s ease, color .2s ease;
    }
    header{
      position:sticky; top:0; z-index:20; backdrop-filter: blur(8px);
      background: rgba(17,24,39,.7);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:auto; padding:20px}
    .hero{display:grid; grid-template-columns:1.2fr .8fr; gap:24px; align-items:center}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h1{font-size:clamp(1.6rem,3.2vw,2.4rem); margin:.4rem 0 .2rem}
    .subtitle{color:var(--muted); font-weight:600; letter-spacing:.3px; margin-bottom:0.4rem}
    h2{font-size:1.25rem; margin:0 0 8px}
    h3{font-size:1.05rem; margin:18px 0 8px}
    p{opacity:.9}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border); background:linear-gradient(180deg, color-mix(in oklab, var(--card) 85%, black 5%), var(--card));
      color:var(--ink); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700
    }
    .btn.primary{background:linear-gradient(180deg,#f59e0b,#b45309); border-color:#b45309; color:#111827}
    .btn.ghost{background:transparent}
    .btn.toggle{font-weight:600}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:var(--chip); border-radius:999px; padding:6px 10px; font-size:.85rem; color:var(--muted); border:1px solid var(--border)}
    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .top3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    @media (max-width:940px){
      .hero{grid-template-columns:1fr}
      .grid.cols-3, .grid.cols-2{grid-template-columns:1fr}
      .top3{grid-template-columns:1fr}
      .wrap{padding:16px}
      .row.stack-sm{flex-direction:column; align-items:stretch}
      .btn.block-sm{width:100%}
    }

    body.kiosk .wrap{max-width:1300px}
    body.kiosk h1{font-size:clamp(2.2rem,4.5vw,3.2rem)}
    body.kiosk h2{font-size:clamp(1.4rem,2.2vw,1.8rem)}
    body.kiosk h3{font-size:clamp(1.2rem,2vw,1.4rem)}
    body.kiosk .btn{padding:14px 18px; font-size:1.05rem}
    body.kiosk .likert input{width:28px; height:28px}
    body.kiosk .q{padding:18px 18px}
    body.kiosk .subtitle{font-size:1.05rem}

    .section-title{display:flex; align-items:center; gap:10px; margin:6px 0 12px}
    .section-title b{color:var(--brand)}
    .progress{height:10px; background:color-mix(in oklab, var(--bg) 80%, black 10%); border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),#fbbf24)}

    .q{padding:14px 16px; border-radius:12px; border:1px solid var(--border); background:color-mix(in oklab, var(--card) 92%, transparent)}
    .q .q-head{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .q .q-body{margin-top:10px}
    .likert{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
    .likert label{display:flex; flex-direction:column; align-items:center; gap:6px; font-size:.95rem; color:var(--muted)}
    .likert input{width:22px; height:22px}
    .options{display:grid; gap:8px}

    .results{display:grid; gap:16px}
    .bar{height:14px; background:color-mix(in oklab, var(--bg) 80%, black 10%); border-radius:8px; position:relative; overflow:hidden; border:1px solid var(--border)}
    .bar i{position:absolute; inset:0; width:0%; background:linear-gradient(90deg,#22d3ee,#0284c7)}

    .tag{font-weight:700; letter-spacing:.4px}
    .tag.alta{color:var(--ok)}
    .tag.buena{color:#a3e635}
    .tag.explo{color:var(--warn)}
    .tag.baja{color:var(--bad)}

    .tcard{border:1px solid var(--border); background:color-mix(in oklab, var(--card) 94%, transparent); border-radius:14px; padding:12px}
    .tcard h4{margin:0 0 6px}
    .small{font-size:.85rem; color:var(--muted)}

    .notice{padding:10px 12px; border-radius:10px; background:color-mix(in oklab, var(--brand) 15%, transparent); border:1px dashed color-mix(in oklab, var(--brand) 45%, transparent)}
    .footer{margin:40px 0 20px; text-align:center; color:var(--muted); font-size:.9rem}
    .danger{outline:2px solid var(--bad); border-radius:8px}
    .okmsg{color:var(--ok); font-weight:600}
    .errmsg{color:var(--bad); font-weight:600}

    .toolbar{display:flex; gap:8px; align-items:center}
    .toolbar .state{font-size:.85rem; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap row stack-sm" style="justify-content:space-between; gap:16px">
      <div>
        <div class="muted" style="font-weight:600; letter-spacing:.5px">Liceo Bicentenario Industrial Ingeniero Ricardo Fenner Ruedi</div>
        <h1 style="margin:2px 0 0">Test de Orientaci√≥n TP</h1>
        <div class="subtitle">by Centro de Innovaci√≥n - Industrial 4.0</div>
      </div>
      <div class="row stack-sm toolbar">
        <button class="btn toggle block-sm" id="themeBtn" type="button" aria-pressed="false" title="Cambiar tema">üåô Tema</button>
        <button class="btn toggle block-sm" id="kioskBtn" type="button" aria-pressed="false" title="Modo kiosko">üñ•Ô∏è Kiosko</button>
        <button class="btn block-sm" onclick="window.print()">Imprimir / Guardar PDF</button>
        <button class="btn primary block-sm" onclick="scrollToEl('#test')">Hacer el test</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="display:grid; gap:24px; margin-top:16px">
    <section class="hero">
      <div class="card">
        <h2>Descubre tu <span style="color:var(--brand)">Top 3</span> de especialidades</h2>
        <p>Responde intereses, habilidades, mini-conocimientos y situaciones. Al final ver√°s tu afinidad con **CM, IS, ED, EL, MA**, tu sem√°foro y el <b>Top 3</b>.</p>
        <div class="chips" style="margin:12px 0 0">
          <span class="chip">Orientativo, no selectivo</span>
          <span class="chip">Seguridad &amp; calidad</span>
          <span class="chip">Trabajo colaborativo</span>
        </div>
        <div style="height:12px"></div>
        <div class="notice">Tus respuestas son confidenciales. √ösalo para conversar con docentes, visitar talleres y decidir con tranquilidad.</div>
      </div>
      <div class="card">
        <div class="section-title"><b>Progreso</b> <span class="muted" id="progText">0/50 respondidas</span></div>
        <div class="progress"><i id="progBar"></i></div>
        <div style="height:10px"></div>
        <form id="testForm" onsubmit="handleSubmit(event)">
          <div class="grid cols-2">
            <div>
              <label class="muted">Nombre</label>
              <input id="nombre" class="q" style="width:100%; background:transparent; color:var(--ink); border-color:var(--border)" placeholder="Nombre y apellido" required />
            </div>
            <div>
              <label class="muted">Curso</label>
              <select id="curso" class="q" style="width:100%; background:transparent; color:var(--ink); border-color:var(--border)" required>
                <option value="" disabled selected>Selecciona tu curso</option>
                <option>2¬∞ A</option>
                <option>2¬∞ B</option>
                <option>2¬∞ C</option>
                <option>2¬∞ D</option>
                <option>2¬∞ E</option>
                <option>2¬∞ F</option>
                <option>2¬∞ G</option>
              </select>
            </div>
            <div>
              <label class="muted">Email</label>
              <input id="email" type="email" class="q" style="width:100%; background:transparent; color:var(--ink); border-color:var(--border)" placeholder="nombre@correo.cl" required />
            </div>
            <div class="row" style="align-items:end; gap:10px">
              <button type="button" class="btn ghost" onclick="resetAll()">Borrar todo</button>
            </div>
          </div>

          <section id="test" class="card" style="margin-top:16px">
            <div class="section-title"><b>Parte A</b> <span class="muted">Intereses y motivaciones (1‚Äì5)</span></div>
            <div id="parteA" class="grid" style="gap:10px"></div>
            <hr style="border:0; border-top:1px solid var(--border); margin:16px 0">
            <div class="section-title"><b>Parte B</b> <span class="muted">Habilidades auto-percibidas (1‚Äì5)</span></div>
            <div id="parteB" class="grid" style="gap:10px"></div>
            <hr style="border:0; border-top:1px solid var(--border); margin:16px 0">
            <div class="section-title"><b>Parte C</b> <span class="muted">Mini-conocimientos (alternativa √∫nica)</span></div>
            <div id="parteC" class="grid" style="gap:10px"></div>
            <hr style="border:0; border-top:1px solid var(--border); margin:16px 0">
            <div class="section-title"><b>Parte D</b> <span class="muted">Situaciones reales (elige lo que har√≠as primero)</span></div>
            <div id="parteD" class="grid" style="gap:10px"></div>
          </section>

          <section class="card" style="margin-top:16px">
            <div class="row" style="justify-content:space-between; align-items:center">
              <div class="section-title"><b>Resultados</b> <span class="muted">A+B+C (+2 correctas) + D (+3 preferencia)</span></div>
              <div class="row stack-sm">
                <button id="calcBtn" class="btn block-sm" type="submit">Calcular y enviar</button>
                <button class="btn primary block-sm" type="button" onclick="scrollToEl('#resumen')">Ver resumen</button>
              </div>
            </div>

            <div id="resumen" class="results">
              <div class="grid cols-3">
                <div class="q">
                  <h3 style="margin-top:0">Puntajes por especialidad</h3>
                  <div id="scores"></div>
                </div>
                <div class="q">
                  <h3 style="margin-top:0">Sem√°foro</h3>
                  <div id="semaforos"></div>
                </div>
                <div class="q">
                  <h3 style="margin-top:0">Preferencias Parte D</h3>
                  <div id="dprefs"></div>
                </div>
              </div>

              <div class="q">
                <h3 style="margin-top:0">Top 3 recomendado</h3>
                <div class="top3" id="top3"></div>
                <div class="small" style="margin-top:8px">* Empates se resuelven con preferencia de la Parte D.</div>
                <div id="sendStatus" style="margin-top:8px"></div>
              </div>
            </div>
          </section>
        </form>
      </div>
    </section>

    <div class="footer">¬© LBIIRFR ‚Äî Herramienta orientativa. Construyamos tu futuro t√©cnico con prop√≥sito.</div>
  </main>

<script>
  // ===== Tema (light/dark) con persistencia =====
  const themeBtn = document.getElementById('themeBtn');
  const kioskBtn = document.getElementById('kioskBtn');
  const THEME_KEY = 'fenner_theme';
  const KIOSK_KEY = 'fenner_kiosk';

  function setTheme(theme){
    if(theme==='light'){ document.body.setAttribute('data-theme','light'); }
    else { document.body.removeAttribute('data-theme'); theme='dark'; }
    localStorage.setItem(THEME_KEY, theme);
    themeBtn.innerText = theme==='light' ? '‚òÄÔ∏è Tema' : 'üåô Tema';
    themeBtn.setAttribute('aria-pressed', theme==='light');
  }
  function toggleTheme(){
    const current = localStorage.getItem(THEME_KEY) || 'dark';
    setTheme(current==='dark' ? 'light' : 'dark');
  }
  themeBtn.addEventListener('click', toggleTheme);
  setTheme(localStorage.getItem(THEME_KEY) || 'dark');

  // ===== Kiosk (fullscreen + UI XL) con persistencia =====
  async function enterFullscreen(){
    const el = document.documentElement;
    if(!document.fullscreenElement){
      try{ await el.requestFullscreen(); }catch(e){ /* ignora */ }
    }
  }
  async function exitFullscreen(){
    if(document.fullscreenElement){
      try{ await document.exitFullscreen(); }catch(e){ /* ignora */ }
    }
  }
  async function setKiosk(on){
    if(on){
      document.body.classList.add('kiosk');
      localStorage.setItem(KIOSK_KEY, 'on');
      kioskBtn.innerText = 'üóó Salir Kiosko';
      kioskBtn.setAttribute('aria-pressed','true');
      await enterFullscreen();
    }else{
      document.body.classList.remove('kiosk');
      localStorage.setItem(KIOSK_KEY, 'off');
      kioskBtn.innerText = 'üñ•Ô∏è Kiosko';
      kioskBtn.setAttribute('aria-pressed','false');
      await exitFullscreen();
    }
  }
  kioskBtn.addEventListener('click', ()=>{
    const on = (localStorage.getItem(KIOSK_KEY) || 'off') === 'off';
    setKiosk(on);
  });
  setKiosk((localStorage.getItem(KIOSK_KEY) || 'off') === 'on');

  // ===== Configuraci√≥n de env√≠o por correo (Apps Script) =====
  const EMAIL_ENDPOINT = https://script.google.com/a/macros/industrialfenner.cl/s/AKfycbx0sUycXFejuNY33GPw3TougLpGFDSdAVQY_SE__7Efoi2HFvG69fhNfjUlNqZEvp91/exec; // Pega aqu√≠ tu URL del Web App (termina en /exec)
  const EMAIL_TO = "ebellor@industrialfenner.cl";

  const SPEC = {
    CM: { name: 'Construcciones Met√°licas' },
    IS: { name: 'Instalaciones Sanitarias' },
    ED: { name: 'Edificaci√≥n' },
    EL: { name: 'Electricidad' },
    MA: { name: 'Mec√°nica Automotriz' },
  };

  const A_ITEMS = [
    [1,'Disfruto medir, trazar y cortar piezas para que calcen al mil√≠metro.','CM'],
    [2,'Me atrae armar estructuras resistentes (rejas, marcos, soportes).','CM'],
    [3,'Puedo imaginar c√≥mo doblar o soldar una pieza para que cumpla una funci√≥n.','CM'],
    [4,'Me fijo en √°ngulos, escuadras y alineaci√≥n cuando construyo.','CM'],
    [5,'Me interesa c√≥mo circula el agua y dise√±ar recorridos eficientes.','IS'],
    [6,'Me gusta instalar y sellar ca√±er√≠as sin filtraciones.','IS'],
    [7,'Puedo interpretar s√≠mbolos b√°sicos de gasfiter√≠a/sanitarios.','IS'],
    [8,'Me entretiene calcular pendientes para que el agua evacue bien.','IS'],
    [9,'Me gusta leer planos y visualizar un espacio terminado.','ED'],
    [10,'Disfruto planificar etapas de construcci√≥n y coordinar tareas.','ED'],
    [11,'Soy bueno detectando riesgos en obra y proponiendo medidas.','ED'],
    [12,'Me importan la est√©tica y funcionalidad de un espacio.','ED'],
    [13,'Me interesa armar circuitos y entender por qu√© enciende/apaga.','EL'],
    [14,'Me atrae el orden en canalizaciones y tableros.','EL'],
    [15,'Disfruto resolver fallas el√©ctricas buscando causas.','EL'],
    [16,'Me gusta trabajar con mult√≠metro y seguir esquemas.','EL'],
    [17,'Me fascina c√≥mo funcionan motores y transmisiones.','MA'],
    [18,'Disfruto desarmar y volver a armar mecanismos.','MA'],
    [19,'Me gusta diagnosticar ruidos o vibraciones de un veh√≠culo.','MA'],
    [20,'Me interesa el mantenimiento preventivo y la seguridad en taller.','MA'],
  ];

  const B_ITEMS = [
    [21,'Tengo buena coordinaci√≥n ojo-mano para trabajos finos.','CM'],
    [22,'Mantengo medidas exactas con huincha/escuadra.','CM'],
    [23,'Puedo soldar/pegar con prolijidad o aprendo r√°pido.','CM'],
    [24,'Identifico di√°metros de tuber√≠as y fittings con facilidad.','IS'],
    [25,'Puedo sellar uniones ordenadas y revisar fugas con m√©todo.','IS'],
    [26,'S√© usar nivel (manguera/burbuja) y marcar pendientes.','IS'],
    [27,'Organizo equipos y tiempos para cumplir una meta.','ED'],
    [28,'Redacto instrucciones claras y hago checklists.','ED'],
    [29,'Identifico materiales adecuados para cada etapa.','ED'],
    [30,'Distingo serie vs. paralelo en lo b√°sico.','EL'],
    [31,'Trabajo seguro: corto energ√≠a, etiqueto y verifico.','EL'],
    [32,'Sigo planos el√©ctricos sin perderme.','EL'],
    [33,'Uso herramientas de mano y cuido torques/aprietes.','MA'],
    [34,'Sigo secuencias de desmontaje sin ‚Äúsobrar piezas‚Äù.','MA'],
    [35,'Detecto s√≠ntomas (temperatura, olores, ruidos) y saco hip√≥tesis.','MA'],
  ];

  const C_ITEMS = [
    { n:1, spec:'EL', text:'En un circuito en serie, si se abre un interruptor, la corriente‚Ä¶', opts:{A:'Aumenta', B:'Disminuye a la mitad', C:'Se interrumpe', D:'Pasa por una parte'}, key:'C' },
    { n:2, spec:'IS', text:'Para que un desag√ºe funcione por gravedad, la pendiente debe ser‚Ä¶', opts:{A:'0%', B:'Muy alta', C:'Moderada y constante', D:'Negativa'}, key:'C' },
    { n:3, spec:'CM', text:'Para verificar 90¬∞ entre dos piezas, se usa:', opts:{A:'Pie de rey', B:'Escuadra met√°lica', C:'Llave ajustable', D:'Alicate'}, key:'B' },
    { n:4, spec:'MA', text:'El torque correcto en una tuerca evita:', opts:{A:'Aumentar potencia', B:'Aflojamientos/sobreapriete', C:'Consumo', D:'Vel. m√°xima'}, key:'B' },
    { n:5, spec:'ED', text:'En un plano escala 1:50:', opts:{A:'1 cm plano = 50 cm reales', B:'1 cm real = 50 cm plano', C:'50 cm plano = 1 cm real', D:'Igual a 1:5'}, key:'A' },
    { n:6, spec:'EL', text:'Un mult√≠metro en voltaje DC se conecta‚Ä¶', opts:{A:'En serie', B:'En paralelo', C:'Solo a tierra', D:'Como sea'}, key:'B' },
    { n:7, spec:'IS', text:'El tefl√≥n/c√°√±amo se usa para‚Ä¶', opts:{A:'Aumentar caudal', B:'Evitar corrosi√≥n', C:'Sellar roscas', D:'Pegar PVC'}, key:'C' },
    { n:8, spec:'CM', text:'Para marcar un corte recto largo en plancha conviene:', opts:{A:'Flex√≥metro curvo', B:'Regla/gu√≠a larga + marcador', C:'Pinza', D:'Martillo'}, key:'B' },
    { n:9, spec:'ED', text:'EPP obligatorio al cortar con sierra:', opts:{A:'Guantes de lana', B:'Lentes + protecci√≥n auditiva', C:'Sandalias', D:'Gorro'}, key:'B' },
    { n:10, spec:'MA', text:'Un auto tira a la derecha al frenar:', opts:{A:'Alternador', B:'Desalineaci√≥n/freno der. m√°s fuerte', C:'Bater√≠a', D:'Buj√≠as'}, key:'B' },
  ];

  const D_ITEMS = [
    { n:1, text:'Soporte para se√±al en la plaza del liceo:', map:{A:'CM',B:'IS',C:'ED',D:'EL',E:'MA'}, opts:{A:'Dise√±ar y soldar un marco firme',B:'Medir pendientes y evacuar aguas',C:'Dibujar plano con ubicaci√≥n/anclajes',D:'Calcular alimentaci√≥n e iluminaci√≥n',E:'Revisar herramientas y aprietes'} },
    { n:2, text:'Corte en circuito de enchufes en casa:', map:{A:'EL',B:'ED',C:'CM',D:'MA',E:'IS'}, opts:{A:'Verificar continuidad / protecci√≥n',B:'Ordenar canalizaci√≥n y cargas',C:'Hacer soporte met√°lico a canaletas',D:'Revisar aprietes en tablero',E:'Ver si agua/humedad afecta'} },
    { n:3, text:'Tuber√≠a rota en el patio:', map:{A:'IS',B:'CM',C:'ED',D:'EL',E:'MA'}, opts:{A:'Cerrar llave y hacer by-pass',B:'Abrazadera met√°lica provisional',C:'Evaluar da√±os y actualizar plano',D:'Proteger cables/energ√≠a del sector',E:'Revisar bomba/motor por da√±os'} },
    { n:4, text:'Rampa para cargar materiales al cami√≥n:', map:{A:'CM',B:'ED',C:'MA',D:'EL',E:'IS'}, opts:{A:'Dise√±ar estructura y refuerzos',B:'Pendiente, barandas y flujo',C:'Chequear frenos del cami√≥n',D:'Iluminaci√≥n y alarma de retroceso',E:'Drenaje superficial para lluvia'} },
    { n:5, text:'Auto del taller no parte tras 2 meses:', map:{A:'MA',B:'EL',C:'ED',D:'CM',E:'IS'}, opts:{A:'Bater√≠a y conexiones',B:'Fusibles/circuito de arranque',C:'Rutina de mantenci√≥n preventiva',D:'Soporte met√°lico para bater√≠a',E:'Mangueras/estanque por fugas/derrames'} },
  ];

  function renderLikert(containerId, items){
    const host = document.querySelector(containerId);
    items.forEach(([n, text, spec])=>{
      const q = document.createElement('div');
      q.className = 'q';
      q.innerHTML = `
        <div class="q-head"><div><b>${n}.</b> ${text}</div></div>
        <div class="q-body likert" role="radiogroup" aria-label="${n}">
          ${[1,2,3,4,5].map((v,idx)=>`
            <label>
              <input type="radio" name="q${n}" value="${v}" ${idx===0?'required':''} />
              <span>${v}</span>
            </label>
          `).join('')}
        </div>`;
      host.appendChild(q);
    });
  }

  function renderMulti(containerId, items, namePrefix){
    const host = document.querySelector(containerId);
    items.forEach((qObj)=>{
      const {n, text, opts} = qObj;
      const q = document.createElement('div');
      q.className = 'q';
      q.innerHTML = `
        <div class="q-head"><div><b>${namePrefix}${n}.</b> ${text}</div></div>
        <div class="q-body options" role="radiogroup" aria-label="${namePrefix}${n}">
          ${['A','B','C','D','E'].filter(k=>opts[k]).map((k,idx)=>`
            <label class="row" style="gap:10px; align-items:center">
              <input type="radio" name="${namePrefix}${n}" value="${k}" ${idx===0?'required':''} />
              <span><b>${k})</b> ${opts[k]}</span>
            </label>
          `).join('')}
        </div>`;
      host.appendChild(q);
    });
  }

  function scrollToEl(sel){ document.querySelector(sel)?.scrollIntoView({behavior:'smooth'}); }
  function getRadio(name){ const el = document.querySelector(`input[name="${name}"]:checked`); return el?el.value:null; }
  function countAnswered(){
    let total=0; for(let i=1;i<=20;i++){ if(getRadio('q'+i)) total++; }
    for(let i=21;i<=35;i++){ if(getRadio('q'+i)) total++; }
    for(let i=1;i<=10;i++){ if(getRadio('C'+i)) total++; }
    for(let i=1;i<=5;i++){ if(getRadio('D'+i)) total++; }
    document.getElementById('progBar').style.width = Math.round(100*total/50)+"%";
    document.getElementById('progText').textContent = `${total}/50 respondidas`;
  }
  document.addEventListener('change', (e)=>{ if(e.target.matches('input[type="radio"]')) countAnswered(); });

  function resetAll(){
    document.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=false);
    document.getElementById('nombre').value='';
    document.getElementById('curso').value='';
    document.getElementById('email').value='';
    countAnswered();
    document.getElementById('scores').innerHTML='';
    document.getElementById('semaforos').innerHTML='';
    document.getElementById('dprefs').innerHTML='';
    document.getElementById('top3').innerHTML='';
    document.getElementById('sendStatus').innerHTML='';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function calcular(){
    const totals = {CM:0,IS:0,ED:0,EL:0,MA:0};
    const dpref  = {CM:0,IS:0,ED:0,EL:0,MA:0};
    A_ITEMS.forEach(([n,_t,s])=> totals[s]+= +getRadio('q'+n));
    B_ITEMS.forEach(([n,_t,s])=> totals[s]+= +getRadio('q'+n));
    C_ITEMS.forEach(({n,key,spec})=>{ const ans=getRadio('C'+n); if(ans && ans.toUpperCase()===key) totals[spec]+=2; });
    D_ITEMS.forEach(({n,map})=>{ const ans=getRadio('D'+n); const sp=map[ans]; if(sp){ totals[sp]+=3; dpref[sp]+=3; } });

    const arr = Object.keys(SPEC).map(k=>({k, name:SPEC[k].name, total:totals[k], tie:dpref[k]}));
    arr.sort((a,b)=> (b.total-a.total) || (b.tie-a.tie));
    const top = arr.slice(0,3);

    renderResults(totals, dpref, top);
    return { totals, dpref, top };
  }

  function renderResults(totals, dpref, top){
    const max=54; const scores=document.getElementById('scores'); scores.innerHTML='';
    Object.keys(SPEC).forEach(k=>{
      const row=document.createElement('div');
      const pct=Math.max(0,Math.min(100,Math.round(100*totals[k]/max)));
      row.style.marginBottom='10px';
      row.innerHTML=`
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>${SPEC[k].name}</div>
          <div><b>${totals[k]}</b> / ${max}</div>
        </div>
        <div class="bar" aria-label="${SPEC[k].name}"><i style="width:${pct}%;"></i></div>`;
      scores.appendChild(row);
    });

    const sema=document.getElementById('semaforos'); sema.innerHTML='';
    Object.keys(SPEC).forEach(k=>{
      const v=totals[k]; let tagTxt,cls; if(v>=42){tagTxt='Alta';cls='alta'} else if(v>=34){tagTxt='Buena';cls='buena'} else if(v>=26){tagTxt='En exploraci√≥n';cls='explo'} else {tagTxt='Baja';cls='baja'}
      const item=document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style.marginBottom='8px';
      item.innerHTML=`<span>${SPEC[k].name}</span> <span class="tag ${cls}">${tagTxt}</span>`; sema.appendChild(item);
    });

    const dbox=document.getElementById('dprefs'); dbox.innerHTML='';
    Object.keys(SPEC).forEach(k=>{ const item=document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style;marginBottom='8px'; item.innerHTML=`<span>${SPEC[k].name}</span> <span>${dpref[k]}</span>`; dbox.appendChild(item); });

    const top3=document.getElementById('top3'); top3.innerHTML='';
    top.forEach((t,idx)=>{ const c=document.createElement('div'); c.className='tcard'; c.innerHTML=`<h4>${idx+1}¬∞ ‚Äî ${t.name}</h4><div class="small">Puntaje: <b>${t.total}</b> (desempate D: ${t.tie})</div>`; top3.appendChild(c); });
  }

  function validateAll(){
    const form = document.getElementById('testForm');
    if(!form.reportValidity()) return false;
    const missing=[];
    for(let i=1;i<=20;i++) if(!getRadio('q'+i)) missing.push('A'+i);
    for(let i=21;i<=35;i++) if(!getRadio('q'+i)) missing.push('B'+i);
    for(let i=1;i<=10;i++) if(!getRadio('C'+i)) missing.push('C'+i);
    for(let i=1;i<=5;i++) if(!getRadio('D'+i)) missing.push('D'+i);
    document.querySelectorAll('.danger').forEach(n=>n.classList.remove('danger'));
    if(missing.length){
      missing.slice(0,20).forEach(tag=>{
        const id = tag.startsWith('A')||tag.startsWith('B') ? 'q'+parseInt(tag.replace(/[^0-9]/g,'')) : tag;
        const input = document.querySelector(`input[name="${id}"]`);
        if(input) input.closest('.q').classList.add('danger');
      });
      alert('Faltan respuestas: '+missing.slice(0,8).join(', ')+(missing.length>8?'‚Ä¶':''));
      return false;
    }
    return true;
  }

  async function handleSubmit(ev){
    ev.preventDefault();
    if(!validateAll()) return;
    const result = calcular();
    await sendEmail(result);
    scrollToEl('#resumen');
  }

  async function sendEmail(result){
    const status = document.getElementById('sendStatus');
    status.textContent = 'Enviando resultados al correo institucional‚Ä¶'; status.className='small';

    const student = {
      nombre: document.getElementById('nombre').value.trim(),
      curso:  document.getElementById('curso').value,
      email:  document.getElementById('email').value.trim()
    };

    const payload = {
      to: EMAIL_TO,
      subject: `Resultados Test Orientaci√≥n TP ‚Äî ${student.nombre} (${student.curso})`,
      student,
      totals: result.totals,
      dpref: result.dpref,
      top3: result.top.map(t=>({ especialidad:t.name, puntaje:t.total, desempateD:t.tie })),
      timestamp: new Date().toISOString()
    };

    try{
      if(EMAIL_ENDPOINT && EMAIL_ENDPOINT.startsWith('http')){
        await fetch(EMAIL_ENDPOINT, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
        status.textContent = 'Resultados enviados (Apps Script, modo no-cors).'; status.className='small okmsg';
      } else {
        status.textContent = 'Configura EMAIL_ENDPOINT con la URL del Web App de Apps Script.'; status.className='small errmsg';
      }
    }catch(err){
      console.error(err);
      status.textContent = 'No se pudo enviar autom√°ticamente. Revisa EMAIL_ENDPOINT.';
      status.className='small errmsg';
    }
  }

  renderLikert('#parteA', A_ITEMS);
  renderLikert('#parteB', B_ITEMS);
  renderMulti('#parteC', C_ITEMS, 'C');
  renderMulti('#parteD', D_ITEMS, 'D');
  countAnswered();
</script>
</body>
</html>
